name: Build Small Tailscale

on:
  push:
    branches:
      - develop
  repository_dispatch:
    types: [upstream_release]
  workflow_dispatch:
    inputs:
      force_version:
        description: 'Build specific version (e.g. v1.50.0). Leave empty for auto-detect.'
        required: false
        default: ''
      skip_check:
        description: 'Skip version check and force build?'
        type: boolean
        required: false
        default: false

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      version: ${{ steps.check.outputs.version }}
    steps:
      - name: Check version
        id: check
        run: |
          # 手動入力がある場合はそちらを優先
          INPUT_VER="${{ inputs.force_version }}"
          SKIP_CHECK="${{ inputs.skip_check }}"
          
          # 公式の最新タグを取得
          LATEST_TAG=$(curl -s https://api.github.com/repos/tailscale/tailscale/releases/latest | jq -r .tag_name)
          
          # 自分のリポジトリの最新リリースを取得
          MY_LATEST=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r .tag_name || echo "v0.0.0")

          echo "Upstream: $LATEST_TAG"
          echo "Current: $MY_LATEST"
          echo "Input: $INPUT_VER"

          if [ -n "$INPUT_VER" ]; then
            echo "Manual version specified."
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "version=$INPUT_VER" >> $GITHUB_OUTPUT
          elif [ "$SKIP_CHECK" == "true" ]; then
             echo "Skipping check, forcing build of $LATEST_TAG"
             echo "should_run=true" >> $GITHUB_OUTPUT
             echo "version=$LATEST_TAG" >> $GITHUB_OUTPUT
          elif [ "$LATEST_TAG" != "$MY_LATEST" ] || [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "New version detected."
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "version=$LATEST_TAG" >> $GITHUB_OUTPUT
          else
            echo "Already up to date."
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  build:
    needs: check-version
    if: needs.check-version.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # --- x86 ---
          - goarch: 386
            openwrt_archs: "i386_pentium-mmx i386_pentium4"

          # --- ARM64 (Raspberry Pi 4, NanoPi, etc.) ---
          - goarch: arm64
            openwrt_archs: "aarch64_cortex-a53 aarch64_cortex-a72 aarch64_cortex-a76 aarch64_generic"

          # --- ARMv7 (Raspberry Pi 2/3, etc.) ---
          - goarch: arm
            goarm: 7
            openwrt_archs: "arm_cortex-a5_vfpv4 arm_cortex-a7 arm_cortex-a7_neon-vfpv4 arm_cortex-a7_vfpv4 arm_cortex-a8_vfpv3 arm_cortex-a9 arm_cortex-a9_neon arm_cortex-a9_vfpv3-d16 arm_cortex-a15_neon-vfpv4"

          # --- ARMv6 (Raspberry Pi 1 / Zero) ---
          - goarch: arm
            goarm: 6
            openwrt_archs: "arm_arm1176jzf-s_vfp"

          # --- ARMv5 ---
          - goarch: arm
            goarm: 5
            openwrt_archs: "arm_arm926ej-s arm_xscale"

          # --- MIPS Big Endian (Atheros AR7xxx/AR9xxx, QCA9xxx) ---
          - goarch: mips
            gomips: softfloat
            openwrt_archs: "mips_24kc mips_4kec mips_mips32"

          # --- MIPS Little Endian (MediaTek MT76x8, Omega2, etc.) ---
          - goarch: mipsle
            gomips: softfloat
            openwrt_archs: "mipsel_24kc mipsel_24kc_24kf mipsel_74kc mipsel_mips32"

          # --- RISC-V ---
          - goarch: riscv64
            openwrt_archs: "riscv64_riscv64"

          # --- PowerPC64 ---
          - goarch: ppc64
            openwrt_archs: "powerpc64_e5500"

          # --- x86_64 ---
          - goarch: amd64
            openwrt_archs: "x86_64"

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4
        with:
          path: my-repo

      - name: Checkout Tailscale
        uses: actions/checkout@v4
        with:
          repository: tailscale/tailscale
          ref: ${{ needs.check-version.outputs.version }}
          path: tailscale-src
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache-dependency-path: tailscale-src/go.sum

      - name: Install UPX
        run: sudo apt-get install -y upx-ucl

      - name: Build Small Tailscale
        working-directory: tailscale-src
        env:
          GOOS: linux
          GOARCH: ${{ matrix.goarch }}
          GOARM: ${{ matrix.goarm }}
          GOMIPS: ${{ matrix.gomips }}
          CGO_ENABLED: 0
        run: |
          chmod +x ./build_dist.sh
          echo "Building tailscale.combined for $GOARCH using build_dist.sh..."
          ./build_dist.sh --extra-small --box -o ../tailscale.combined ./cmd/tailscaled

      - name: Compress binaries with UPX
        run: |
          upx --best --lzma tailscale.combined || echo "Warning: UPX compression failed for tailscale.combined (Arch: ${{ matrix.goarch }}). Using uncompressed binary."

      - name: Package into IPK
        run: |
          VERSION=${{ needs.check-version.outputs.version }}
          VERSION_NUM=${VERSION#v}
          
          # 出力先ディレクトリ
          mkdir -p artifacts
          
          # アーキテクチャリストをループ
          for ARCH in ${{ matrix.openwrt_archs }}; do
            echo "Packaging for $ARCH..."
            
            # ビルド用の一時ディレクトリをクリーンアップ
            rm -rf ipk_build
            mkdir -p ipk_build/data/usr/sbin
            mkdir -p ipk_build/data/etc/init.d
            mkdir -p ipk_build/control
            
            # --- data ---
            cp tailscale.combined ipk_build/data/usr/sbin/
            cd ipk_build/data/usr/sbin
            ln -s tailscale.combined tailscale
            ln -s tailscale.combined tailscaled
            cd ../../../..
            cp my-repo/openwrt/tailscale.init ipk_build/data/etc/init.d/tailscale
            chmod +x ipk_build/data/etc/init.d/tailscale
            
            # build data.tar.gz
            cd ipk_build/data
            tar --numeric-owner --group=0 --owner=0 -czf ../data.tar.gz *
            cd ../..
            
            # --- control ---
            cp my-repo/openwrt/control ipk_build/control/control
            sed -i "s/VERSION_PLACEHOLDER/$VERSION_NUM/g" ipk_build/control/control
            sed -i "s/ARCH_PLACEHOLDER/$ARCH/g" ipk_build/control/control
            
            # dataのサイズを計算して Installed-Size に設定
            SIZE=$(du -sb ipk_build/data | awk '{ print $1 }')
            echo "Installed-Size: $SIZE" >> ipk_build/control/control
            
            # build control.tar.gz
            cd ipk_build/control
            tar --numeric-owner --group=0 --owner=0 -czf ../control.tar.gz *
            cd ../..
            
            # --- .ipk ---
            echo "2.0" > ipk_build/debian-binary
            cd ipk_build
            IPK_NAME="tailscale_${VERSION_NUM}_${ARCH}.ipk"
            tar --numeric-owner --group=0 --owner=0 -czf "$IPK_NAME" debian-binary data.tar.gz control.tar.gz
            
            # 生成物を退避
            mv "$IPK_NAME" ../artifacts/
            cd ..
          done
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tailscale_pkgs_${{ matrix.goarch }}_${{ matrix.goarm || '0' }}
          path: "artifacts/*.ipk"

  release:
    needs: [check-version, build]
    if: needs.check-version.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.check-version.outputs.version }}
          name: Small Tailscale ${{ needs.check-version.outputs.version }}
          body: |
            Auto-generated small build for OpenWrt.
            Upstream: https://github.com/tailscale/tailscale/releases/tag/${{ needs.check-version.outputs.version }}
            
            **Build Flags:** `--extra-small --box`
            **Compression:** UPX --best --lzma
          files: artifacts/*.ipk
          prerelease: false

  deploy-repo:
    needs: [check-version, build]
    if: needs.check-version.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: repo-page
        continue-on-error: true

      - name: Initialize Repo Directory
        run: |
          if [ ! -d "repo-page" ]; then
            mkdir repo-page
            cd repo-page
            git init
            git checkout -b gh-pages
            cd ..
          fi

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate Index
        run: |
          cd repo-page
          find ../artifacts -type f -name "*.ipk" | while read IPK; do
            echo "Processing $IPK..."
            ARCH_NAME=$(basename "$IPK" | sed -E 's/^tailscale_[^_]+_(.+)\.ipk$/\1/')
            mkdir -p "$ARCH_NAME"

            # ipkの更新
            rm -f "$ARCH_NAME"/*.ipk
            cp "$IPK" "$ARCH_NAME"/
          done
          
          # インデックス生成
          for ARCH_DIR in */; do
            if [ -d "$ARCH_DIR" ]; then
              cd "$ARCH_DIR"
              echo "Generating index for $ARCH_DIR..."
              echo "" > Packages
              for IPK in *.ipk; do
                tar -xzOf "$IPK" control.tar.gz | tar xzO control >> Packages
                echo "Filename: $IPK" >> Packages
                echo "Size: $(stat -c%s "$IPK")" >> Packages
                echo "SHA256sum: $(sha256sum "$IPK" | cut -d' ' -f1)" >> Packages
                echo "" >> Packages
              done
              gzip -k -f Packages
              cd ..
              else
                # 不要な空ディレクトリがあれば削除
                echo "Skipping $ARCH_DIR (no ipk files)"
                cd .. && rm -rf "$ARCH_DIR" && continue
            fi
          done

      - name: Deploy to GitHub Pages
        working-directory: repo-page
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .

          # 変更がない場合のエラー回避
          git commit -m "Update repo ${{ needs.check-version.outputs.version }}" || echo "No changes to commit"

          # 強制プッシュで履歴を上書きしないとリポジトリが肥大化するため注意
          # 容量節約なら --force 推奨
          git push origin HEAD:gh-pages