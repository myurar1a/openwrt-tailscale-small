name: Build Small Tailscale

on:
  push:
    branches:
      - develop
  repository_dispatch:
    types: [upstream_release]
  workflow_dispatch:
    inputs:
      force_version:
        description: 'Build specific version (e.g. v1.50.0). Leave empty for auto-detect.'
        required: false
        default: ''
      skip_check:
        description: 'Skip version check and force build?'
        type: boolean
        required: false
        default: false

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      version: ${{ steps.check.outputs.version }}
    steps:
      - name: Check version
        id: check
        run: |
          # 手動入力がある場合はそれを優先
          INPUT_VER="${{ inputs.force_version }}"
          SKIP_CHECK="${{ inputs.skip_check }}"
          
          # 公式の最新タグを取得
          LATEST_TAG=$(curl -s https://api.github.com/repos/tailscale/tailscale/releases/latest | jq -r .tag_name)
          
          # 自分のリポジトリの最新リリースを取得
          MY_LATEST=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r .tag_name || echo "v0.0.0")

          echo "Upstream: $LATEST_TAG"
          echo "Current: $MY_LATEST"
          echo "Input: $INPUT_VER"

          if [ -n "$INPUT_VER" ]; then
            echo "Manual version specified."
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "version=$INPUT_VER" >> $GITHUB_OUTPUT
          elif [ "$SKIP_CHECK" == "true" ]; then
             echo "Skipping check, forcing build of $LATEST_TAG"
             echo "should_run=true" >> $GITHUB_OUTPUT
             echo "version=$LATEST_TAG" >> $GITHUB_OUTPUT
          elif [ "$LATEST_TAG" != "$MY_LATEST" ] || [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "New version detected."
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "version=$LATEST_TAG" >> $GITHUB_OUTPUT
          else
            echo "Already up to date."
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  build:
    needs: check-version
    if: needs.check-version.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # --- x86 / x86_64 (PC / Server) ---
          - goarch: 386
            openwrt_arch: i386_pentium4
          - goarch: amd64
            openwrt_arch: x86_64

          # --- ARM64 (Raspberry Pi 4, NanoPi, etc.) ---
          # "generic" covers cortex-a53, a72, a76
          - goarch: arm64
            openwrt_arch: aarch64_generic

          # --- ARMv7 (Raspberry Pi 2/3, etc.) ---
          # "arm_cortex-a9" covers cortex-a5, a7, a8, a15 (neon/vfpv3/vfpv4)
          - goarch: arm
            goarm: 7
            openwrt_arch: arm_cortex-a9

          # --- ARMv6 (Raspberry Pi 1 / Zero) ---
          - goarch: arm
            goarm: 6
            openwrt_arch: arm_arm1176jzf-s_vfp

          # --- ARMv5 ---
          # "arm926ej-s" covers xscale
          - goarch: arm
            goarm: 5
            openwrt_arch: arm_arm926ej-s

          # --- MIPS Big Endian (Atheros AR7xxx/AR9xxx, QCA9xxx) ---
          - goarch: mips
            gomips: softfloat
            openwrt_arch: mips_24kc

          # --- MIPS Little Endian (MediaTek MT76x8, Omega2, etc.) ---
          - goarch: mipsle
            gomips: softfloat
            openwrt_arch: mipsel_24kc

          # --- RISC-V ---
          - goarch: riscv64
            openwrt_arch: riscv64_riscv64

          # --- PowerPC64 ---
          - goarch: ppc64
            openwrt_arch: powerpc64_e5500

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4
        with:
          path: my-repo

      - name: Checkout Tailscale
        uses: actions/checkout@v4
        with:
          repository: tailscale/tailscale
          ref: ${{ needs.check-version.outputs.version }}
          path: tailscale-src

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install UPX and build tools
        run: sudo apt-get install -y upx-ucl fakeroot

      - name: Build Small Tailscale
        working-directory: tailscale-src
        env:
          GOOS: linux
          GOARCH: ${{ matrix.goarch }}
          GOARM: ${{ matrix.goarm }}
          GOMIPS: ${{ matrix.gomips }}
          CGO_ENABLED: 0
        run: |
          TAGS="ts_omit_aws,ts_omit_bird,ts_omit_tap,ts_omit_kube,ts_omit_wifi,ts_omit_uiserver"
          LDFLAGS="-s -w"
          echo "Building for $GOARCH (OpenWrt: ${{ matrix.openwrt_arch }})..."
          go build -tags "$TAGS" -ldflags "$LDFLAGS" -o ../tailscaled ./cmd/tailscaled
          go build -tags "$TAGS" -ldflags "$LDFLAGS" -o ../tailscale ./cmd/tailscale

      - name: Compress binaries with UPX
        run: |
          # Try to compress with UPX.
          # If UPX fails (unsupported arch like mips64, riscv64, etc.), 
          # it prints a warning and proceeds with the uncompressed binary.
          
          for BIN in tailscaled tailscale; do
            upx --best --lzma "$BIN" || echo "Warning: UPX compression failed for $BIN (Arch: ${{ matrix.goarch }}). Using uncompressed binary."
          done

      - name: Package into IPK
        run: |
          VERSION=${{ needs.check-version.outputs.version }}
          VERSION_NUM=${VERSION#v}
          ARCH=${{ matrix.openwrt_arch }}
          
          # 作業用ディレクトリの作成
          mkdir -p ipk_build/data/usr/sbin
          mkdir -p ipk_build/data/etc/init.d
          mkdir -p ipk_build/control
          
          # --- 1. data の準備 ---
          cp tailscaled ipk_build/data/usr/sbin/
          cp tailscale ipk_build/data/usr/sbin/
          cp my-repo/openwrt/tailscale.init ipk_build/data/etc/init.d/tailscale
          chmod +x ipk_build/data/etc/init.d/tailscale
          
          # data.tar.gz の作成
          cd ipk_build/data
          tar --numeric-owner --group=0 --owner=0 -czf ../data.tar.gz *
          cd ../..
          
          # --- 2. control の準備 ---
          cp my-repo/openwrt/control ipk_build/control/control
          sed -i "s/VERSION_PLACEHOLDER/$VERSION_NUM/g" ipk_build/control/control
          sed -i "s/ARCH_PLACEHOLDER/$ARCH/g" ipk_build/control/control
          
          # dataディレクトリのサイズを計算して Installed-Size に設定
          SIZE=$(du -sb ipk_build/data | awk '{ print $1 }')
          echo "Installed-Size: $SIZE" >> ipk_build/control/control
          
          # control.tar.gz の作成
          cd ipk_build/control
          tar --numeric-owner --group=0 --owner=0 -czf ../control.tar.gz *
          cd ../..
          
          # --- 3. .ipk ファイルの作成 ---
          echo "2.0" > ipk_build/debian-binary
          
          # .ipk の作成
          cd ipk_build
          tar --numeric-owner --group=0 --owner=0 -czf tailscale_${VERSION_NUM}_${ARCH}.ipk debian-binary data.tar.gz control.tar.gz

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tailscale_${{ matrix.openwrt_arch }}
          path: "ipk_build/*.ipk"

  release:
    needs: [check-version, build]
    if: needs.check-version.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.check-version.outputs.version }}
          name: Small Tailscale ${{ needs.check-version.outputs.version }}
          body: |
            Auto-generated small build for OpenWrt.
            Upstream: https://github.com/tailscale/tailscale/releases/tag/${{ needs.check-version.outputs.version }}
            
            **Build Tags:** `ts_omit_aws, ts_omit_bird, ts_omit_tap, ts_omit_kube, ts_omit_wifi, ts_omit_uiserver`
            **Compression:** UPX --best --lzma
          files: artifacts/*.ipk
          prerelease: true # テスト中はプレリリース

  deploy-repo:
    needs: [check-version, build]
    if: needs.check-version.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: repo-page
        continue-on-error: true # 初回はブランチがないためエラー許容

      - name: Initialize Repo Directory
        run: |
          if [ ! -d "repo-page" ]; then
            mkdir repo-page
            cd repo-page
            git init
            git checkout -b gh-pages
            cd ..
          fi

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate Index
        run: |
          cd repo-page
          for ARCH_DIR in ../artifacts/*; do
            ARCH_NAME=$(basename "$ARCH_DIR" | sed 's/tailscale_//')
            mkdir -p "$ARCH_NAME"
            rm -f "$ARCH_NAME"/*.ipk
            cp "$ARCH_DIR"/*.ipk "$ARCH_NAME"/
            cd "$ARCH_NAME"
            echo "" > Packages
            for IPK in *.ipk; do
              ar p "$IPK" control.tar.gz | tar xzO ./control >> Packages
              echo "Filename: $IPK" >> Packages
              echo "Size: $(stat -c%s "$IPK")" >> Packages
              echo "SHA256sum: $(sha256sum "$IPK" | cut -d' ' -f1)" >> Packages
              echo "" >> Packages
            done
            gzip -k -f Packages
            cd ..
          done

      - name: Deploy to GitHub Pages
        working-directory: repo-page
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .

          # 変更がない場合のエラー回避
          git commit -m "Update repo ${{ needs.check-version.outputs.version }}" || echo "No changes to commit"

          # 強制プッシュで履歴を上書きしないとリポジトリが肥大化するため注意
          # 容量節約なら --force 推奨
          git push origin HEAD:gh-pages